<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fraud Tracker SDK Playground</title>
  <style>
    :root {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--surface-light);
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--danger);
    }

    .status-dot.active {
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .card h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    button {
      padding: 0.625rem 1.25rem;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      background: var(--accent);
      color: white;
    }

    button:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button.secondary {
      background: var(--surface-light);
    }

    button.danger {
      background: var(--danger);
    }

    .test-area {
      margin-top: 1rem;
    }

    .test-area label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      margin-top: 0.75rem;
    }

    input, textarea {
      width: 100%;
      padding: 0.75rem;
      border-radius: 8px;
      border: 1px solid var(--surface-light);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
    }

    .stat {
      text-align: center;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .log {
      max-height: 300px;
      overflow-y: auto;
      background: var(--bg);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.75rem;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 0.25rem;
    }

    .log-entry.mouse { color: #a78bfa; }
    .log-entry.keystroke { color: #34d399; }
    .log-entry.keystroke_dynamics { color: #22c55e; }
    .log-entry.scroll { color: #fbbf24; }
    .log-entry.touch { color: #f472b6; }
    .log-entry.visibility { color: #60a5fa; }
    .log-entry.focus { color: #818cf8; }
    .log-entry.paste { color: #fb923c; }
    .log-entry.device { color: #2dd4bf; }
    .log-entry.performance { color: #c084fc; }
    .log-entry.system { color: var(--text-muted); font-style: italic; }

    .signal-counts {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .signal-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .mouse_move { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }
    .mouse_click { background: rgba(167, 139, 250, 0.3); color: #c4b5fd; }
    .keystroke { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    .keystroke_dynamics { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .scroll { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .touch { background: rgba(244, 114, 182, 0.2); color: #f472b6; }
    .visibility { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
    .focus { background: rgba(129, 140, 248, 0.2); color: #818cf8; }
    .paste { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
    .device { background: rgba(45, 212, 191, 0.2); color: #2dd4bf; }
    .performance { background: rgba(192, 132, 252, 0.2); color: #c084fc; }

    .canvas-area {
      width: 100%;
      height: 200px;
      background: var(--bg);
      border-radius: 8px;
      margin-top: 1rem;
      position: relative;
      overflow: hidden;
    }

    #mouseCanvas {
      width: 100%;
      height: 100%;
    }

    .typing-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .typing-stat {
      padding: 0.75rem;
      background: var(--bg);
      border-radius: 6px;
      font-size: 0.75rem;
    }

    .typing-stat-label {
      color: var(--text-muted);
    }

    .typing-stat-value {
      font-weight: 600;
      color: var(--success);
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîç Fraud Tracker SDK Playground</h1>
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Not initialized</span>
      </div>
    </header>

    <div class="grid">
      <!-- Controls -->
      <div class="card">
        <h2>Controls</h2>
        <div class="controls">
          <button id="initBtn">Initialize Tracker</button>
          <button id="completeBtn" class="secondary" disabled>Complete Session</button>
          <button id="clearBtn" class="danger">Clear Log</button>
        </div>
        
        <div class="test-area">
          <label>Session ID</label>
          <input type="text" id="sessionId" readonly placeholder="Initialize to get session ID">
          
          <label>Test Input (type here to capture keystroke dynamics)</label>
          <textarea id="testInput" placeholder="Start typing to capture keystroke dynamics..."></textarea>
        </div>
      </div>

      <!-- Stats -->
      <div class="card">
        <h2>Session Stats</h2>
        <div class="stats">
          <div class="stat">
            <div class="stat-value" id="signalCount">0</div>
            <div class="stat-label">Signals</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="flushCount">0</div>
            <div class="stat-label">Flushes</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="duration">0s</div>
            <div class="stat-label">Duration</div>
          </div>
        </div>
        
        <div class="signal-counts" id="signalCounts"></div>

        <div class="typing-stats" id="typingStats">
          <div class="typing-stat">
            <div class="typing-stat-label">Avg Dwell</div>
            <div class="typing-stat-value" id="avgDwell">-</div>
          </div>
          <div class="typing-stat">
            <div class="typing-stat-label">Avg Flight</div>
            <div class="typing-stat-value" id="avgFlight">-</div>
          </div>
          <div class="typing-stat">
            <div class="typing-stat-label">Est. WPM</div>
            <div class="typing-stat-value" id="estWpm">-</div>
          </div>
          <div class="typing-stat">
            <div class="typing-stat-label">Error Rate</div>
            <div class="typing-stat-value" id="errorRate">-</div>
          </div>
        </div>
      </div>

      <!-- Mouse Visualization -->
      <div class="card">
        <h2>Mouse Tracking</h2>
        <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem;">
          Move your mouse in this area to see tracking visualization
        </p>
        <div class="canvas-area">
          <canvas id="mouseCanvas"></canvas>
        </div>
      </div>

      <!-- Signal Log -->
      <div class="card">
        <h2>Signal Log</h2>
        <div class="log" id="log"></div>
      </div>
    </div>
  </div>

  <!-- Import the actual SDK from the browser package -->
  <script type="module">
    // Import the actual SDK from the built browser package
    import tracker, { FraudTracker } from '../../src/sdks/browser/dist/fraud-tracker.js';

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Playground UI Logic
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    let startTime = null;
    let signalCounts = {};
    let totalSignals = 0;
    let flushCount = 0;
    let durationInterval = null;

    // DOM elements
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const initBtn = document.getElementById('initBtn');
    const completeBtn = document.getElementById('completeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const sessionIdInput = document.getElementById('sessionId');
    const logEl = document.getElementById('log');
    const signalCountEl = document.getElementById('signalCount');
    const flushCountEl = document.getElementById('flushCount');
    const durationEl = document.getElementById('duration');
    const signalCountsEl = document.getElementById('signalCounts');
    
    // Typing stats
    const avgDwellEl = document.getElementById('avgDwell');
    const avgFlightEl = document.getElementById('avgFlight');
    const estWpmEl = document.getElementById('estWpm');
    const errorRateEl = document.getElementById('errorRate');

    // Mouse canvas
    const canvas = document.getElementById('mouseCanvas');
    const ctx = canvas.getContext('2d');
    let mouseTrail = [];

    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function log(message, type = 'system') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateSignalCounts() {
      signalCountsEl.innerHTML = Object.entries(signalCounts)
        .map(([type, count]) => `<span class="signal-badge ${type}">${type}: ${count}</span>`)
        .join('');
    }

    function updateDuration() {
      if (!startTime) return;
      const seconds = Math.floor((Date.now() - startTime) / 1000);
      durationEl.textContent = `${seconds}s`;
    }

    function drawMouseTrail() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (mouseTrail.length < 2) return;
      
      ctx.beginPath();
      ctx.strokeStyle = '#3b82f6';
      ctx.lineWidth = 2;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      const canvasRect = canvas.getBoundingClientRect();
      
      for (let i = 0; i < mouseTrail.length; i++) {
        const point = mouseTrail[i];
        const x = point.x - canvasRect.left;
        const y = point.y - canvasRect.top;
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
        
        // Fade older points
        const alpha = (i / mouseTrail.length) * 0.8 + 0.2;
        ctx.strokeStyle = `rgba(59, 130, 246, ${alpha})`;
      }
      
      ctx.stroke();
      
      // Draw current point
      if (mouseTrail.length > 0) {
        const last = mouseTrail[mouseTrail.length - 1];
        const x = last.x - canvasRect.left;
        const y = last.y - canvasRect.top;
        
        ctx.beginPath();
        ctx.arc(x, y, 5, 0, Math.PI * 2);
        ctx.fillStyle = '#3b82f6';
        ctx.fill();
      }
    }

    // Signal callback handler
    function handleSignal(signal) {
      totalSignals++;
      signalCounts[signal.type] = (signalCounts[signal.type] || 0) + 1;
      signalCountEl.textContent = totalSignals;
      updateSignalCounts();
      
      // Shorten payload for log
      let payloadStr = JSON.stringify(signal.payload);
      if (payloadStr.length > 60) payloadStr = payloadStr.slice(0, 60) + '...';
      log(`${signal.type}: ${payloadStr}`, signal.type);
      
      // Track mouse for canvas
      if (signal.type === 'mouse_move') {
        mouseTrail.push({ x: signal.payload.x, y: signal.payload.y });
        if (mouseTrail.length > 100) mouseTrail.shift();
        drawMouseTrail();
      }
    }

    // Flush callback handler
    function handleFlush(signals) {
      flushCount++;
      flushCountEl.textContent = flushCount;
      log(`Flushed ${signals.length} signals to server`, 'system');
    }

    // Typing stats callback handler
    function handleTypingStats(stats) {
      avgDwellEl.textContent = `${stats.avgDwellTimeMs}ms`;
      avgFlightEl.textContent = `${stats.avgFlightTimeMs}ms`;
      estWpmEl.textContent = stats.estimatedWPM;
      errorRateEl.textContent = `${(stats.errorRate * 100).toFixed(1)}%`;
    }

    // Session start callback handler
    function handleSessionStart(session) {
      sessionIdInput.value = session.id;
      statusDot.classList.add('active');
      statusText.textContent = 'Tracking active';
      initBtn.disabled = true;
      completeBtn.disabled = false;
      
      startTime = Date.now();
      durationInterval = setInterval(updateDuration, 1000);
      
      log(`Session started: ${session.id}`, 'system');
    }

    // Button handlers
    initBtn.addEventListener('click', async () => {
      initBtn.disabled = true;
      statusText.textContent = 'Connecting...';
      
      try {
        await tracker.init({
          endpoint: 'http://localhost:4000',
          clientId: 'playground-user',
          batchSize: 50,
          flushInterval: 500,
          debug: true,
          // SDK callbacks
          onSignal: handleSignal,
          onFlush: handleFlush,
          onTypingStats: handleTypingStats,
          onSessionStart: handleSessionStart,
        });
      } catch (err) {
        log(`Failed to initialize: ${err}`, 'system');
        initBtn.disabled = false;
        statusText.textContent = 'Connection failed';
      }
    });

    completeBtn.addEventListener('click', async () => {
      log('Completing session...', 'system');
      await tracker.complete();
      
      statusDot.classList.remove('active');
      statusText.textContent = 'Session completed';
      initBtn.disabled = false;
      completeBtn.disabled = true;
      
      clearInterval(durationInterval);
      
      log('Session completed', 'system');
      
      // Reset UI state
      totalSignals = 0;
      flushCount = 0;
      signalCounts = {};
      mouseTrail = [];
      signalCountEl.textContent = '0';
      flushCountEl.textContent = '0';
      durationEl.textContent = '0s';
      avgDwellEl.textContent = '-';
      avgFlightEl.textContent = '-';
      estWpmEl.textContent = '-';
      errorRateEl.textContent = '-';
      updateSignalCounts();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    clearBtn.addEventListener('click', () => {
      logEl.innerHTML = '';
      log('Log cleared', 'system');
    });

    log('Playground ready. Click "Initialize Tracker" to start.', 'system');
    log('Using actual SDK from @fraud/browser-sdk package', 'system');
    log('Connected to real .NET Ingestion API at http://localhost:4000', 'system');
  </script>
</body>
</html>
